<script>
  let carts = JSON.parse(localStorage.getItem("carts")) || {}; // { storeKey: { productName: {price, qty} } }
  let orders = JSON.parse(localStorage.getItem("orders")) || [];
  let currentStore = null;

  const defaultStores = {
    million: {
      name: "Million",
      products: [
        { name: "–ú–æ–ª–æ–∫–æ 1–ª", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–•–ª–µ–±", price: 0, category: "–•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞" },
        { name: "–Ø–π—Ü–∞ 10—à—Ç", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–°–∞—Ö–∞—Ä 1–∫–≥", price: 0, category: "–ë–∞–∫–∞–ª–µ—è" },
        { name: "–†–∏—Å 1–∫–≥", price: 0, category: "–ë–∞–∫–∞–ª–µ—è" },
        { name: "–ú–∞—Å–ª–æ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ", price: 0, category: "–ë–∞–∫–∞–ª–µ—è" },
        { name: "–°—ã—Ä 200–≥", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–ö–æ–ª–±–∞—Å–∞", price: 0, category: "–ú—è—Å–æ –∏ —Ä—ã–±–∞" },
        { name: "–ú–∞–∫–∞—Ä–æ–Ω—ã", price: 0, category: "–ë–∞–∫–∞–ª–µ—è" },
        { name: "–ß–∞–π", price: 0, category: "–ù–∞–ø–∏—Ç–∫–∏" },
        { name: "–ö–æ—Ñ–µ", price: 0, category: "–ù–∞–ø–∏—Ç–∫–∏" },
        { name: "–®–æ–∫–æ–ª–∞–¥", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" }
      ]
    },
    mush: {
      name: "’Ñ’∏÷Ç’∑",
      products: [
        { name: "–ú–æ–ª–æ–∫–æ 1–ª", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–ô–æ–≥—É—Ä—Ç", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–ö–µ—Ñ–∏—Ä", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–°–º–µ—Ç–∞–Ω–∞", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–•–ª–µ–±", price: 0, category: "–•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞" },
        { name: "–Ø–π—Ü–∞", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–°—ã—Ä", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–ö–æ–ª–±–∞—Å–∞", price: 0, category: "–ú—è—Å–æ –∏ —Ä—ã–±–∞" },
        { name: "–ú—è—Å–æ –∫—É—Ä–∏–Ω–æ–µ", price: 0, category: "–ú—è—Å–æ –∏ —Ä—ã–±–∞" },
        { name: "–ú—è—Å–æ –≥–æ–≤—è–¥–∏–Ω–∞", price: 0, category: "–ú—è—Å–æ –∏ —Ä—ã–±–∞" },
        { name: "–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" },
        { name: "–¢–≤–æ—Ä–æ–≥", price: 0, category: "–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã" }
      ]
    },
    tonoyan: {
      name: "Tonoyan",
      products: [
        { name: "–û–≤–æ—â–∏ –∞—Å—Å–æ—Ä—Ç–∏", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–§—Ä—É–∫—Ç—ã –∞—Å—Å–æ—Ä—Ç–∏", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–õ—É–∫", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–ü–æ–º–∏–¥–æ—Ä—ã", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–û–≥—É—Ä—Ü—ã", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–Ø–±–ª–æ–∫–∏", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–ê–ø–µ–ª—å—Å–∏–Ω—ã", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–ë–∞–Ω–∞–Ω—ã", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–ó–µ–ª–µ–Ω—å", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–ì—Ä–∏–±—ã", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" },
        { name: "–ö–∞–ø—É—Å—Ç–∞", price: 0, category: "–û–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã" }
      ]
    },
    danielyan: {
      name: "Danielyan",
      products: [
        { name: "–¢–æ—Ä—Ç —à–æ–∫–æ–ª–∞–¥–Ω—ã–π", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–¢–æ—Ä—Ç –≤–∞–Ω–∏–ª—å–Ω—ã–π", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ü–∏—Ä–æ–∂–Ω–æ–µ —ç–∫–ª–µ—Ä", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ü–∏—Ä–æ–∂–Ω–æ–µ –Ω–∞–ø–æ–ª–µ–æ–Ω", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ü–µ—á–µ–Ω—å–µ –∞—Å—Å–æ—Ä—Ç–∏", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ö—Ä—É–∞—Å—Å–∞–Ω—ã", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ë—É–ª–æ—á–∫–∏", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ü–∞—Ö–ª–∞–≤–∞", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ß–∏–∑–∫–µ–π–∫", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ú–∞—Ñ—Ñ–∏–Ω—ã", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–†—É–ª–µ—Ç—ã", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" },
        { name: "–ö–æ–Ω—Ñ–µ—Ç—ã", price: 0, category: "–°–ª–∞–¥–æ—Å—Ç–∏" }
      ]
    }
  };

  let stores = JSON.parse(localStorage.getItem("stores")) || defaultStores;

  function saveStores() {
    localStorage.setItem("stores", JSON.stringify(stores));
  }

  function saveCarts() {
    localStorage.setItem("carts", JSON.stringify(carts));
  }

  function renderShops() {
    const container = document.getElementById("shops-list");
    container.innerHTML = "";
    Object.keys(stores).forEach(key => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerText = "üõí " + stores[key].name;
      div.onclick = () => openStore(key);
      container.appendChild(div);
    });
  }

  function openStore(storeKey) {
    currentStore = storeKey;
    document.getElementById('home-page').classList.add('hidden');
    document.getElementById('category-page').classList.add('hidden');
    document.getElementById('store-page').classList.remove('hidden');
    document.getElementById('store-title').innerText = stores[storeKey].name;

    const container = document.getElementById('store-products');
    container.innerHTML = '';

    stores[storeKey].products.forEach((item) => {
      const div = document.createElement('div');
      div.className = 'product';
      const qty = carts[storeKey]?.[item.name]?.qty || 0;
      div.innerHTML = `
        <h4>${item.name}</h4>
        <p>–¶–µ–Ω–∞: ${item.price} AMD</p>
        <div class="qty-controls">
          <button onclick="changeQty('${storeKey}', '${item.name}', ${item.price}, -1)">‚àí</button>
          <span class="qty-number" id="qty-${storeKey}-${item.name.replace(/\\s+/g,'')}">${qty}</span>
          <button onclick="changeQty('${storeKey}', '${item.name}', ${item.price}, 1)">+</button>
        </div>
      `;
      container.appendChild(div);
    });

    renderStoreCart(storeKey);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function goHome() {
    document.getElementById('store-page').classList.add('hidden');
    document.getElementById('category-page').classList.add('hidden');
    document.getElementById('admin-login').classList.add('hidden');
    document.getElementById('admin-panel').classList.add('hidden');
    document.getElementById('home-page').classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function changeQty(storeKey, name, price, delta) {
    if (!carts[storeKey]) carts[storeKey] = {};
    if (!carts[storeKey][name]) carts[storeKey][name] = { price, qty: 0 };

    carts[storeKey][name].qty += delta;
    if (carts[storeKey][name].qty <= 0) {
      delete carts[storeKey][name];
    }

    updateQtyDisplay(storeKey, name);
    renderStoreCart(storeKey);
    renderGlobalCart();
    saveCarts();
  }

  function updateQtyDisplay(storeKey, name) {
    const id = `qty-${storeKey}-${name.replace(/\\s+/g,'')}`;
    const el = document.getElementById(id);
    if (el) {
      el.innerText = carts[storeKey]?.[name]?.qty || 0;
    }
  }

  function removeItem(storeKey, name) {
    if (carts[storeKey] && carts[storeKey][name]) {
      delete carts[storeKey][name];
      renderStoreCart(storeKey);
      renderGlobalCart();
      saveCarts();
    }
  }

  function renderStoreCart(storeKey) {
    const container = document.getElementById("store-cart-items");
    container.innerHTML = "";
    let total = 0;

    const storeCart = carts[storeKey] || {};
    Object.keys(storeCart).forEach(name => {
      const item = storeCart[name];
      const sum = item.price * item.qty;
      total += sum;
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <span>${name} √ó ${item.qty}</span>
        <span>${sum} AMD</span>
        <button onclick="removeItem('${storeKey}', '${name}')" style="color:red;border:none;background:none;cursor:pointer;">‚ùå</button>
      `;
      container.appendChild(div);
    });

    document.getElementById("store-cart-total").innerText = `–ò—Ç–æ–≥–æ: ${total} AMD`;
  }

  function renderGlobalCart() {
    const container = document.getElementById("global-cart-items");
    container.innerHTML = "";
    let total = 0;

    Object.keys(carts).forEach(storeKey => {
      const storeName = stores[storeKey].name;
      const storeCart = carts[storeKey];

      if (storeCart && Object.keys(storeCart).length > 0) {
        const storeTitle = document.createElement("div");
        storeTitle.innerHTML = `<strong>${storeName}</strong>`;
        storeTitle.style.marginTop = "10px";
        container.appendChild(storeTitle);

        Object.keys(storeCart).forEach(name => {
          const item = storeCart[name];
          const sum = item.price * item.qty;
          total += sum;

          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
            <span>${name} √ó ${item.qty}</span>
            <span>${sum} AMD</span>
            <button onclick="removeItem('${storeKey}', '${name}')" style="color:red;border:none;background:none;cursor:pointer;">‚ùå</button>
          `;
          container.appendChild(div);
        });
      }
    });

    document.getElementById("global-cart-total").innerText = `–ò—Ç–æ–≥–æ: ${total} AMD`;
  }

  function sendStoreToWhatsApp() {
    if (!currentStore || !carts[currentStore] || Object.keys(carts[currentStore]).length === 0) {
      alert("–ö–æ—Ä–∑–∏–Ω–∞ —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
      return;
    }

    let message = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ ${stores[currentStore].name}:%0A`;
    let total = 0;

    Object.keys(carts[currentStore]).forEach(name => {
      const item = carts[currentStore][name];
      const sum = item.price * item.qty;
      message += `- ${name} √ó ${item.qty}: ${sum} AMD%0A`;
      total += sum;
    });

    message += `%0A–ò—Ç–æ–≥–æ: ${total} AMD`;
    saveOrder(stores[currentStore].name, carts[currentStore], total);

    window.open(`https://wa.me/37443797727?text=${message}`, '_blank');
  }

  function sendStoreToTelegram() {
    if (!currentStore || !carts[currentStore] || Object.keys(carts[currentStore]).length === 0) {
      alert("–ö–æ—Ä–∑–∏–Ω–∞ —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
      return;
    }

    let message = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ ${stores[currentStore].name}:%0A`;
    let total = 0;

    Object.keys(carts[currentStore]).forEach(name => {
      const item = carts[currentStore][name];
      const sum = item.price * item.qty;
      message += `- ${name} √ó ${item.qty}: ${sum} AMD%0A`;
      total += sum;
    });

    message += `%0A–ò—Ç–æ–≥–æ: ${total} AMD`;
    saveOrder(stores[currentStore].name, carts[currentStore], total);

    window.open(`https://t.me/artikfood?text=${message}`, '_blank');
  }

  function saveOrder(storeName, items, total) {
    const order = {
      date: new Date().toLocaleString(),
      store: storeName,
      items: JSON.parse(JSON.stringify(items)),
      total
    };
    orders.push(order);
    localStorage.setItem("orders", JSON.stringify(orders));
  }

  function sendFormToWhatsApp() {
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const address = document.getElementById('address').value;
    const comment = document.getElementById('comment').value;
    const district = document.getElementById('district').value;

    const deliveryPrices = {
      "–¶–µ–Ω—Ç—Ä": 500,
      "–°–µ–≤–µ—Ä": 700,
      "–Æ–≥": 800,
      "–û–∫—Ä–∞–∏–Ω–∞": 1000
    };
    const deliveryCost = deliveryPrices[district] || 0;

    let message = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!%0A–ò–º—è: ${name}%0A–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}%0A–ê–¥—Ä–µ—Å: ${address}%0A–†–∞–π–æ–Ω: ${district}%0A–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏: ${deliveryCost} AMD`;

    let total = deliveryCost;

    Object.keys(carts).forEach(storeKey => {
      const storeCart = carts[storeKey];
      if (storeCart && Object.keys(storeCart).length > 0) {
        message += `%0A%0A–ú–∞–≥–∞–∑–∏–Ω ${stores[storeKey].name}:`;
        Object.keys(storeCart).forEach(name => {
          const item = storeCart[name];
          const sum = item.price * item.qty;
          message += `%0A- ${name} √ó ${item.qty}: ${sum} AMD`;
          total += sum;
        });
      }
    });

    message += `%0A%0A–ò—Ç–æ–≥–æ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π: ${total} AMD`;

    saveOrder("–°–º–µ—à–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑", carts, total);

    window.open(`https://wa.me/37443797727?text=${message}`, '_blank');
  }

  function openCategory(categoryName) {
    document.getElementById('home-page').classList.add('hidden');
    document.getElementById('store-page').classList.add('hidden');
    document.getElementById('category-page').classList.remove('hidden');
    document.getElementById('category-title').innerText = categoryName;

    const container = document.getElementById('category-products');
    container.innerHTML = '';

    Object.keys(stores).forEach(storeKey => {
      const store = stores[storeKey];
      store.products.forEach(item => {
        if (item.category === categoryName) {
          const div = document.createElement('div');
          div.className = 'product';
          div.innerHTML = `
            <h4>${item.name}</h4>
            <p>–¶–µ–Ω–∞: ${item.price} AMD</p>
            <p style="font-size:12px;color:#777;">–ú–∞–≥–∞–∑–∏–Ω: ${store.name}</p>
            <button onclick="openStore('${storeKey}')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω</button>
          `;
          container.appendChild(div);
        }
      });
    });
  }

  function openAdmin() {
    document.getElementById('home-page').classList.add('hidden');
    document.getElementById('store-page').classList.add('hidden');
    document.getElementById('category-page').classList.add('hidden');
    document.getElementById('admin-login').classList.remove('hidden');
  }

  function loginAdmin() {
    const user = document.getElementById('admin-user').value;
    const pass = document.getElementById('admin-pass').value;
    if (user === "admin" && pass === "1234") {
      document.getElementById('admin-login').classList.add('hidden');
      document.getElementById('admin-panel').classList.remove('hidden');
      loadAdminStores();
      renderOrdersReport();
    } else {
      document.getElementById('admin-error').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
    }
  }

  function logoutAdmin() {
    document.getElementById('admin-panel').classList.add('hidden');
    goHome();
  }

  function loadAdminStores() {
    const select = document.getElementById("admin-store-select");
    select.innerHTML = "";
    Object.keys(stores).forEach(key => {
      const option = document.createElement("option");
      option.value = key;
      option.text = stores[key].name;
      select.appendChild(option);
    });
    loadAdminProducts();
  }

  function loadAdminProducts() {
    const storeKey = document.getElementById("admin-store-select").value;
    const list = document.getElementById("admin-products-list");
    list.innerHTML = "";

    stores[storeKey].products.forEach((item, index) => {
      const div = document.createElement("div");
      div.innerHTML = `
        <input type="text" value="${item.name}" onchange="editProductName('${storeKey}', ${index}, this.value)" />
        <input type="number" value="${item.price}" onchange="editProductPrice('${storeKey}', ${index}, this.value)" />
        <input type="text" value="${item.category}" onchange="editProductCategory('${storeKey}', ${index}, this.value)" />
        <button class="danger" onclick="deleteProduct('${storeKey}', ${index})">–£–¥–∞–ª–∏—Ç—å</button>
        <hr/>
      `;
      list.appendChild(div);
    });
  }

  function editProductName(storeKey, index, value) {
    stores[storeKey].products[index].name = value;
    saveStores();
  }

  function editProductPrice(storeKey, index, value) {
    stores[storeKey].products[index].price = Number(value);
    saveStores();
  }

  function editProductCategory(storeKey, index, value) {
    stores[storeKey].products[index].category = value;
    saveStores();
  }

  function deleteProduct(storeKey, index) {
    stores[storeKey].products.splice(index, 1);
    saveStores();
    loadAdminProducts();
  }

  function addProduct() {
    const storeKey = document.getElementById("admin-store-select").value;
    const name = document.getElementById("new-product-name").value;
    const price = Number(document.getElementById("new-product-price").value);
    const category = document.getElementById("new-product-category").value;

    if (!name || price < 0 || !category) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
      return;
    }

    stores[storeKey].products.push({ name, price, category });
    saveStores();
    document.getElementById("new-product-name").value = "";
    document.getElementById("new-product-price").value = "";
    document.getElementById("new-product-category").value = "";
    loadAdminProducts();
  }

  function renderOrdersReport() {
    const container = document.getElementById("orders-report");
    container.innerHTML = "";

    if (orders.length === 0) {
      container.innerHTML = "<p>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>";
      return;
    }

    orders.forEach((order, index) => {
      const div = document.createElement("div");
      div.className = "report-box";
      let itemsText = "";
      Object.keys(order.items).forEach(storeKey => {
        const storeCart = order.items[storeKey];
        if (storeCart && typeof storeCart === "object") {
          itemsText += `<strong>${stores[storeKey]?.name || storeKey}:</strong><br/>`;
          Object.keys(storeCart).forEach(name => {
            const item = storeCart[name];
            itemsText += `- ${name} √ó ${item.qty} = ${item.price * item.qty} AMD<br/>`;
          });
        }
      });

      div.innerHTML = `
        <strong>–ó–∞–∫–∞–∑ #${index + 1}</strong><br/>
        –î–∞—Ç–∞: ${order.date}<br/>
        –ú–∞–≥–∞–∑–∏–Ω: ${order.store}<br/>
        –°—É–º–º–∞: ${order.total} AMD<br/>
        <div>${itemsText}</div>
      `;
      container.appendChild(div);
    });
  }

  renderShops();
  renderGlobalCart();
</script>
